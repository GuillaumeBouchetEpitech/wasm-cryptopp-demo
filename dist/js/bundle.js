"use strict";function e(e,t,i,s){return new(i||(i=Promise))((function(n,o){function r(e){try{a(s.next(e))}catch(e){o(e)}}function l(e){try{a(s.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,l)}a((s=s.apply(e,t||[])).next())}))}class t{constructor(e){this._counter=1,this._textAreaElement=e,this._textAreaElement.value="",this._lines=[],this._maxLines=200}log(...e){if(0==e.length)return;const t=Array.prototype.slice.call(e).join(" ");console.log(t),this._pushText(t)}error(...e){if(0==e.length)return;const t=Array.prototype.slice.call(e).join(" ");console.error(t),this._pushText(`[ERR] - ${t}`)}_pushText(e){this._lines.push(`[${this._counter.toString().padStart(3,"0")}] ${e}`),this._counter+=1,this._lines.length>this._maxLines&&this._lines.splice(0,this._lines.length-this._maxLines),this._textAreaElement.value=`${this._lines.join("\n")}\n`,this._textAreaElement.scrollTop=this._textAreaElement.scrollHeight}get size(){return this._lines.length}peekLast(){if(this._lines.length>0)return this._lines[this._lines.length-1]}popLast(){this._lines.length>0&&this._lines.splice(this._lines.length-1,1)}}class i{constructor(e){this._isInitialized=!1,this._isAborted=!1,this._wasmFunctions={},this._logger=e}initialize(){return e(this,void 0,void 0,(function*(){if(!(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return!1})())throw new Error("missing WebAssembly feature (unsupported)");this._logger.log("[JS][check] WebAssembly feature => supported");const e="web-wasm";return new Promise(((t,i)=>{const s={downloadingDataRegExp:/Downloading data\.\.\. \(([0-9]*)\/([0-9]*)\)/,lastProgressLevel:0,locateFile:t=>`${e}/${t}`,print:e=>{this._logger.log(`[C++][out] ${e}`)},printErr:e=>{this._logger.error(`[C++][err] ${e}`)},setStatus:e=>{if(!e)return;const t=s.downloadingDataRegExp.exec(e);if(t){const e=parseFloat(t[1]),i=parseFloat(t[2]),n=Math.floor(e/i*100);s.lastProgressLevel!==n&&(s.lastProgressLevel=n,this._logger.log(n))}else this._logger.log(`[JS][wasm][status] ${e}`)},onRuntimeInitialized:()=>{this._logger.log("[JS][wasm] loaded"),this._logger.log("[JS][wasm] initializing"),this._wasmFunctions.runDhLogic=window.Module.cwrap("runDhLogic",void 0,[]),this._wasmFunctions.runAesLogic=window.Module.cwrap("runAesLogic",void 0,[]),this._wasmFunctions.makeWasmPrintMessage=window.Module.cwrap("makeWasmPrintMessage",void 0,["number"]),this._wasmFunctions.getHeapString=window.Module.cwrap("getHeapString","number",[]),this._isInitialized=!0,this._logger.log("[JS][wasm] initialized"),t()},noInitialRun:!0,noExitRuntime:!0};var n;window.Module=s,this._logger.log("[JS][wasm] loading"),(n=`./${e}/index.js`,new Promise(((e,t)=>{const i=document.createElement("script");i.src=n,i.addEventListener("load",(()=>e)),i.addEventListener("error",t),document.head.appendChild(i)}))).catch(i)}))}))}runDhLogic(){this._isInitialized&&!this._isAborted&&this._wasmFunctions.runDhLogic&&this._wasmFunctions.runDhLogic()}runAesLogic(){this._isInitialized&&!this._isAborted&&this._wasmFunctions.runAesLogic&&this._wasmFunctions.runAesLogic()}makeWasmPrintMessage(e){if(!this._isInitialized||this._isAborted||!this._wasmFunctions.makeWasmPrintMessage)return;const t=window.Module,i=t.lengthBytesUTF8(e)+1,s=t._malloc(i);t.stringToUTF8(e,s,i),this._wasmFunctions.makeWasmPrintMessage(s),t._free(s)}getHeapString(){if(!this._isInitialized||this._isAborted||!this._wasmFunctions.getHeapString)return;const e=window.Module,t=this._wasmFunctions.getHeapString(),i=e.UTF8ToString(t);return e._free(t),i}abort(){if(!this._isInitialized||this._isAborted)return;this._isAborted=!0;const e=window.Module;e&&(e.setStatus=e=>{e&&this._logger.error(`[JS][wasm][aborted] ${e}`)})}}window.addEventListener("load",(()=>e(void 0,void 0,void 0,(function*(){const e=(e=>{const t=document.querySelector(e);if(!t)throw new Error(`DOM elements not found, id=${e}`);return t})("#loggerOutput"),s=new t(e);s.log("[JS] page loaded");window.addEventListener("error",(e=>{s.error(`[JS] fatal error, event=${e}`)}));const n=new i(s);try{yield n.initialize()}catch(e){s.error(`[JS] dependencies check failed: message="${e.message}"`)}s.log(""),s.log("#"),s.log("# LOGIC START"),s.log(""),s.log("#"),s.log("# test: Diffie Hellman key exchange"),s.log(""),n.runDhLogic(),s.log(""),s.log("#"),s.log("# test: Aes Cipher/Decipher"),s.log(""),n.runAesLogic(),s.log(""),s.log("#"),s.log("# test: print js string inside wasm logic"),s.log(""),n.makeWasmPrintMessage("Hello from JavaScript!"),s.log(""),s.log("#"),s.log("# test: get wasm allocated string as js variable"),s.log("");const o=n.getHeapString();s.log(`wasm text printed in the JS code: "${o}"`),s.log(""),s.log("# LOGIC END"),s.log("#")}))));
